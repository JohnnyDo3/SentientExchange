name: Deploy to Production (Railway)

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy-production:
    name: Deploy to Railway Production
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # This environment requires manual approval in GitHub Settings
    environment:
      name: production
      url: ${{ secrets.RAILWAY_PRODUCTION_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Pre-deployment checks
        run: |
          echo "ğŸš€ Starting production deployment"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "âš ï¸  This is a PRODUCTION deployment"
          echo "    All CI checks must have passed"
          echo "    Manual approval required"

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Deploy to Railway Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PRODUCTION }}
        run: |
          echo "Deploying to Railway Production..."
          railway up --service=agentMarket-mcp || true
          echo "Deployment triggered (log streaming may fail but deployment continues)"

      - name: Wait for deployment
        run: |
          echo "Waiting 60 seconds for Railway production deployment to stabilize..."
          sleep 60

      - name: Run smoke tests
        if: ${{ secrets.RAILWAY_PRODUCTION_URL != '' }}
        run: |
          chmod +x scripts/smoke-test.sh
          bash scripts/smoke-test.sh "${{ secrets.RAILWAY_PRODUCTION_URL }}"

      - name: Create deployment record
        uses: actions/github-script@v8
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              required_contexts: [],
              auto_merge: false,
              description: 'Production deployment via Railway'
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ secrets.RAILWAY_PRODUCTION_URL }}',
              description: 'Deployment successful - smoke tests passed'
            });

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Production deployment succeeded!"
          echo ""
          echo "Environment: master branch â†’ Railway production"
          echo "URL: ${{ secrets.RAILWAY_PRODUCTION_URL }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "All smoke tests passed âœ“"
          echo "Check Railway dashboard for deployment details"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Production deployment failed"
          echo ""
          echo "âš ï¸  IMPORTANT: Production may be in an unstable state"
          echo ""
          echo "Next steps:"
          echo "1. Check Railway dashboard for error logs"
          echo "2. Review the failed step above"
          echo "3. Consider rolling back if necessary"
          echo "4. Investigate and fix the issue before retrying"
          echo ""
          exit 1

      - name: Rollback instructions
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ROLLBACK INSTRUCTIONS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "To rollback this deployment:"
          echo "1. Go to Railway dashboard"
          echo "2. Navigate to agentMarket-mcp service"
          echo "3. Click 'Deployments' tab"
          echo "4. Find the last successful deployment"
          echo "5. Click 'Redeploy' on that deployment"
          echo ""
          echo "Or via CLI:"
          echo "  railway rollback"
          echo ""
